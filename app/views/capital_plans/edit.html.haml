:ruby
  table_dom_id = SecureRandom.hex

= link_to 'Save', complete_actions_capital_plan_path(@capital_plan), :remote => true, :class => 'btn btn-info capital-plan-action'

= render partial: 'capital_plan_table', locals: {show_actions: 1, table_dom_id: table_dom_id}

:javascript

  var selected_plan_actions = [];

  $("##{table_dom_id}").on('click-row.bs.table', function (e, row, $element) {
    var url = path.replace("x", row['object_key']);
    document.location.href = url;
  }).on('check.bs.table', function(e, row) {
    update_selected();
  }).on('uncheck.bs.table', function(e, row) {
    update_selected();
  }).on('check-all.bs.table', function(e, row) {
    update_selected();
  }).on('uncheck-all.bs.table', function(e, row) {
    update_selected();
  }).on('post-body.bs.table', function(e, row) {
    var i, checkbox, $table = $("##{table_dom_id}");
    //update the checkbox selections after the table body is rendered
    for(i=0; i<selected_plan_actions.length; i++){
      checkbox = $table.find('input[type=checkbox][value=' +selected_plan_actions[i]+ ']');
      checkbox.length && checkbox.prop('checked', true) && checkbox.parents('tr').addClass('selected');
    }

  });

  // Enables or disables the package actions depending on how many are selected
  function enable_disable_asset_actions() {
    var $checkbox;
    if (selected_plan_actions.length > 0) {
      $('.move-assets-button').removeClass('disabled');
      if (selected_plan_actions.length == 1) {
        $('#button-text').html("Move 1 asset to fiscal year");
      } else {
        $('#button-text').html("Move " + selected_plan_actions.length + " assets to fiscal year");
      }
    } else {
      $('.move-assets-button').addClass('disabled');
      $('#button-text').html("Move selected to fiscal year");
      $checkbox = $('#' + '#{table_dom_id} input[type=checkbox]')
      $checkbox.prop('checked', false) && $checkbox.parents('tr').removeClass('selected');
    }
  };

  // Updates the selected rows in the table
  function update_selected() {
    var $table, selected, notSelected, removeKey, i;
    $table = $("##{table_dom_id}");
    selected = $table.bootstrapTable('getSelections');
    notSelected = $table.find('input:unchecked').map(function(a,b){ return b.value; })
    //console.log(selected);
    // remove unselected from the selected
    for(i = 0; i < notSelected.length; i++){
      removeKey = selected_plan_actions.indexOf( notSelected[i] );
      if(removeKey > -1){
        selected_plan_actions.splice(removeKey, 1);
      }
    }
    // add selected to selected (if not already there)
    for (i = 0; i < selected.length; i++) {
      var selected_key = selected[i].object_key;
      if(selected_plan_actions.indexOf(selected_key) < 0) {
        selected_plan_actions.push(selected_key);
      }
    }
  };

  $(".capital-plan-action").on('click', function(e) {
      var href = $(this).attr('href');
      href += ('&targets=' + selected_plan_actions.join(','));

      $(this).attr('href', href);
      return true;
    });
  });