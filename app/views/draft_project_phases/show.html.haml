:css
  .with-margin {
    margin-bottom: 5px;
  }

//TITLE
.row.text-center
  %h1
    =@draft_project_phase.name 
  .row
    =@draft_project_phase.justification
  .row
    =link_to edit_draft_project_phase_path(@draft_project_phase) do 
      %i.fa.fa-edit
    = link_to draft_project_phase_path(@draft_project_phase), :method => :delete, :class => "btn btn-xs btn-action", :data => { :confirm => 'Are you sure you want to remove this project phase?' } do
      %i.fa.fa-trash

//Main Content  
.row
  .col-md-1
  
  //Details
  .col-md-3
    .row
      %strong 
        ALI:
      =@draft_project_phase.team_ali_code.try(:code)
    .row
      %strong
        Cost:
      =format_as_currency(@draft_project_phase.cost)
    .row
      %strong
        Allocated:
      =format_as_currency(@draft_project_phase.allocated)
    .row
      %strong
        Remaining:
      =format_as_currency(@draft_project_phase.remaining)
  .col-md-4
    .progress
      .progress-bar.bg-success{role: "progressbar", style: "width: #{@draft_project_phase.percent_funded}%"}
        ="#{@draft_project_phase.percent_funded}% Funded"

  .col-md-4

%br

%div.row
  -count = 0
  -@draft_project_phase.draft_funding_requests.order(:created_at).each do |funding_request|
    .row
      .col-md-2
      .col-md-8
        -if @draft_project_phase.draft_funding_requests.count > 1
          %h4
            =link_to draft_funding_request_path(funding_request), method: :delete, data: {confirm: "Are you sure you want to delete this Funding Request?"} do 
              %i.fa.fa-trash
            ="Funding Request #{count+=1}"
        =render partial: "shared/draft_funding_request_partial", locals: {funding_request: funding_request}
// Funding
%div.row
  .col-md-12.text-center
    %h4
      ="Funding Request"
      =link_to draft_funding_requests_url(draft_project_phase_id: @draft_project_phase.object_key), method: :post, class: "btn btn-info btn-xs" do 
        %i.fa.fa-plus

// Assets
%div.row
  .col-md-12
    %h3
      ="Assets"
=render partial: "phase_assets_table", locals: {draft_project_phase: @draft_project_phase}

:javascript
    // update allocations with an ajax call
    // so we don't need a page reload

    $(document).on("click", "input.toggle_edit", (x)=>{
      let value = $(x.target).siblings("input.edit").val();
      let id = $(x.target).siblings("input.edit").attr("data_id");
      if($(x.target).is(":not(:checked)")){
        $.ajax({
          url: "/draft_budget_allocations/"+id,
          data: {"draft_budget_allocation": {"amount":value}},
          method: 'PUT',
          dataType: 'json',
          success: function(data) {
            console.log("updated allocation");

            let root = $(x.target).closest(".dfrp");
            let total = sum_a($(root).find(".unedit"));

            let actual = (100*(value/total));

            // update actual
            $(x.target).parent().siblings(".alloc_actual").html(actual.toFixed(3) + "%");

            // update total
            $(root).find(".fr_total").html('$' + total.toLocaleString());

          },
          error: function(e) {
            console.log(e);
          }
        });
      }
      $(x.target).siblings(".unedit").text(value);
      $(x.target).siblings().toggle();
      $(x.target).parent().parent().find(".alloc_actions").children().toggle();
    });

    // layout got moved around, but logic is the same
    // if layout is changed again this will have to be updated

    $(document).on("click", ".trigger_toggle_edit", (x)=>{
      $(x.target).parent().parent().find("input.toggle_edit").click(); //yuck
    });

    // helper to update, generates the total
    let sum_a = (l) => {
      let sum = 0;
      l.each(function(){
        sum += Number($(this).text());
      });
      return sum;
    };


    // Edit Total
    $(document).on('click', "input.toggle_edit_total", (x)=>{
      if($(x.target).is(":not(:checked)")){
        $(x.target).siblings(".unedit_total").text($(x.target).siblings("input.edit").val().toLocaleString());
      } else {
        $($(x.target).siblings("input.edit")[0]).val(parseFloat($(x.target).siblings(".unedit_total").text().replace(/[^\d\.\-eE+]/g, "")));
      }
      $(x.target).siblings().toggle();
      $(x.target).closest(".dfrp").find(".total_actions").children().toggle();
      $( "#totalSpinner" ).show();
    });

    // Trigger
    $(document).on("click", ".trigger_toggle_edit_total", (x)=>{
      $(x.target).closest(".dfrp").find("input.toggle_edit_total").click(); //yuck
    });

    $(document).on("click", ".cancel_edit_total", (x)=>{
      let root = $(x.target).closest(".dfrp");
      root.find(".unedit_total").text(root.find("input.edit").val().toLocaleString());
      root.find("input.toggle_edit_total").click();
    });

